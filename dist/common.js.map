{"version":3,"file":"common.js","sources":["../common.js"],"sourcesContent":["function noop() {}\nexports.noop = noop\nexports.stop = Symbol('stop')\n    //第一次调用有效\nexports.once = f => (...args) => {\n    if (f) {\n        let r = f(...args)\n        f = null\n        return r\n    }\n}\n\nclass Sink {\n    constructor(sink, ...args) {\n        this.defers = new Set()\n        this.sink = sink\n        this.init(...args)\n        if (sink) sink.defers.add(this)\n    }\n    init() {\n\n    }\n    set disposePass(value) {\n        if (!this.sink) return\n        if (value)\n            this.sink.defers.add(this)\n        else this.sink.defers.delete(this)\n    }\n    next(data) {\n        this.sink && this.sink.next(data)\n    }\n    complete(err) {\n        this.sink && this.sink.complete(err)\n        this.dispose(false)\n    }\n    error(err) {\n        this.complete(err)\n    }\n    dispose(defer = true) {\n        this.disposed = true\n        this.complete = noop\n        this.next = noop\n        this.dispose = noop\n        this.subscribes = this.subscribe = noop\n        defer && this.defer() //销毁时终止事件源\n    }\n    defer(add) {\n        if (add) {\n            this.defers.add(add)\n        } else {\n            this.defers.forEach(defer => {\n                switch (true) {\n                    case defer.dispose != void 0:\n                        defer.dispose()\n                        break;\n                    case typeof defer == 'function':\n                        defer()\n                        break\n                    case defer.length > 0:\n                        let [f, thisArg, ...args] = defer\n                        if (f.call)\n                            f.call(thisArg, ...args)\n                        else f(...args)\n                        break\n                }\n            })\n            this.defers.clear()\n        }\n    }\n    subscribe(source) {\n        source(this)\n        return this\n    }\n    subscribes(sources) {\n        sources.forEach(source => source(this))\n    }\n}\nexports.Sink = Sink\nclass Asap {\n    constructor() {\n        this.asaps = []\n        this._asaps = []\n    }\n    push(task) {\n        this.asaps.push(task)\n    }\n    _push(task) {\n        this._asaps.push(task)\n    }\n    run(task) {\n        this.run = this.push\n        if (task) this.asaps.push(task)\n        Promise.resolve(this).then(_this => {\n            _this.run = _this._push\n            for (let i = 0, l = _this.asaps.length; i < l; i++) {\n                _this.asaps[i]()\n            }\n            _this.asaps = _this._asaps\n            _this._asaps = []\n            delete _this.run;\n            if (_this.asaps.length) {\n                _this.run()\n            }\n        })\n    }\n}\n\nconst _asap = new Asap\n\nfunction asap(task, defer) {\n    _asap.run(task)\n    return defer\n}\nexports.asap = asap;\n\nexports.deliver = Class => (...args) => source => sink => source(new Class(sink, ...args))"],"names":["noop","exports","stop","Symbol","once","f","r","Sink","sink","defers","Set","args","init","add","data","next","err","complete","dispose","defer","disposed","subscribes","subscribe","forEach","length","thisArg","call","clear","source","sources","value","delete","Asap","asaps","_asaps","task","push","run","Promise","resolve","then","_this","_push","i","l","_asap","asap","deliver","Class"],"mappings":"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"}