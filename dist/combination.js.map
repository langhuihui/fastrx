{"version":3,"file":"combination.js","sources":["../combination.js"],"sourcesContent":["const {\n    Sink\n} = require('./common')\nclass Share extends Sink {\n    init(source) {\n        this.source = source\n        this.sinks = new Set()\n    }\n    add(sink) {\n        this.sinks.add(sink)\n        if (this.sinks.size === 1) {\n            this.source(this)\n        }\n    }\n    remove(sink) {\n        this.sinks.delete(sink)\n        if (this.sinks.size === 0) {\n            this.defer()\n        }\n    }\n    next(data) {\n        this.sinks.forEach(s => s.next(data))\n    }\n    complete(err) {\n        this.sinks.forEach(s => s.complete(err))\n        this.sinks.clear()\n    }\n}\nexports.share = () => source => {\n    const share = new Share(null, source)\n    return sink => {\n        sink.defer([share.remove, share, sink])\n        share.add(sink);\n    }\n}\nexports.shareReplay = bufferSize => source => {\n    const share = new Share(null, source)\n    const buffer = []\n    share.next = function (data) {\n        buffer.push(data)\n        if (buffer.length > bufferSize) {\n            buffer.shift()\n        }\n        this.sinks.forEach(s => s.next(data))\n    }\n    return sink => {\n        sink.defer([share.remove, share, this])\n        buffer.forEach(cache => sink.next(cache))\n        share.add(sink);\n    }\n}\nexports.iif = (condition, trueS, falseS) => sink => condition() ? trueS(sink) : falseS(sink)\nclass Race extends Sink {\n    init(nLife) {\n        this.nLife = nLife;\n    }\n    next(data) {\n        this.defer()\n        this.sink.next(data)\n        super.complete()\n    }\n    complete(err) {\n        if (--this.nLife === 0) super.complete(err)\n    }\n}\nexports.race = (...sources) => sink => new Race(sink, sources.length).subscribes(sources)\nclass Concat extends Sink {\n    init(sources) {\n        this.sources = sources\n        this.pos = 0\n        this.len = sources.length\n    }\n    complete(err) {\n        if (err) {\n            super.complete(err)\n            return\n        }\n        if (this.pos < this.len && !this.disposed) this.sources[this.pos++](this)\n        else super.complete()\n    }\n}\nexports.concat = (...sources) => sink => new Concat(sink, sources).complete()\n\nclass Merge extends Sink {\n    init(nLife) {\n        this.nLife = nLife;\n    }\n    complete() {\n        if (--this.nLife === 0) super.complete()\n    }\n}\nexports.mergeArray = sources => sink => new Merge(sink, sources.length).subscribes(sources)\nexports.merge = (...sources) => sink => new Merge(sink, sources.length).subscribes(sources)\nclass CombineLatest extends Sink {\n    init(index, array, context) {\n        this.index = index\n        this.context = context\n        this.state = 0\n        this.array = array\n    }\n    next(data) {\n        switch (this.state) {\n            case 0:\n                ++this.context.nRun;\n                this.state = 1\n            case 1:\n                if (this.context.nRun === this.context.nTotal) {\n                    this.state = 2\n                } else {\n                    this.array[this.index] = data\n                    break\n                }\n            case 2:\n                this.array[this.index] = data\n                this.sink.next(this.array)\n                break\n        }\n    }\n    complete(err) {\n        if (err || (--this.context.nLife) === 0) super.complete(err)\n    }\n}\nexports.combineLatest = (...sources) => sink => {\n    const nTotal = sources.length;\n    const context = {\n        nTotal,\n        nLife: nTotal,\n        nRun: 0\n    }\n    const array = new Array(nTotal)\n    // const defers = new Array(nTotal)\n    // for (let i = 0; i < nTotal; ++i) defers[i] = sources[i](new CombineLatest(sink, i, array, context))\n    sources.forEach((source, i) => source(new CombineLatest(sink, i, array, context)))\n}\nclass Zip extends Sink {\n    init(index, array, context) {\n        this.index = index\n        this.context = context\n        this.array = array\n        this.buffer = []\n        array[index] = this.buffer\n    }\n    next(data) {\n        this.buffer.push(data)\n        if (this.array.every(x => x.length)) {\n            this.sink.next(this.array.map(x => x.shift()))\n        }\n    }\n    complete(err) {\n        if (err || (--this.context.nLife) === 0) super.complete(err)\n    }\n}\nexports.zip = (...sources) => sink => {\n    const nTotal = sources.length;\n    const context = {\n        nTotal,\n        nLife: nTotal\n    }\n    const array = new Array(nTotal)\n    sources.forEach((source, i) => source(new Zip(sink, i, array, context)))\n}\n\nexports.startWith = (...xs) => inputSource => (sink, pos = 0, l = xs.length) => {\n    while (pos < l) {\n        if (sink.disposed) return\n        sink.next(xs[pos++])\n    }\n    sink.disposed || inputSource(sink)\n}"],"names":["require","Sink","Share","source","sinks","Set","sink","add","size","delete","defer","data","forEach","s","next","err","complete","clear","exports","share","remove","shareReplay","bufferSize","buffer","push","length","shift","cache","iif","condition","trueS","falseS","Race","nLife","race","sources","subscribes","Concat","pos","len","disposed","concat","Merge","mergeArray","merge","CombineLatest","index","array","context","state","nRun","nTotal","combineLatest","Array","i","Zip","every","x","map","zip","startWith","xs","inputSource","l"],"mappings":"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"}