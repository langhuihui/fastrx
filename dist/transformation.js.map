{"version":3,"file":"transformation.js","sources":["../transformation.js"],"sourcesContent":["const {\r\n    Sink,\r\n    deliver\r\n} = require('./common')\r\nconst {\r\n    MapSink\r\n} = require('./fusion')\r\nclass Scan extends Sink {\r\n    init(hasSeed, f, seed) {\r\n        this.f = f\r\n        this.aac = seed\r\n        if (!hasSeed) {\r\n            this.next = d => {\r\n                delete this.next\r\n                this.sink.next(this.aac = d)\r\n            }\r\n        }\r\n    }\r\n    next(data) {\r\n        const f = this.f\r\n        this.aac = f(this.aac, data)\r\n        this.sink.next(this.aac)\r\n    }\r\n}\r\nexports.scan = (...args) => source => sink => source(new Scan(sink, args.length == 2, ...args))\r\n\r\nexports.map = f => source => sink => source(sink.fusionMap ? sink.fusionMap(f) : new MapSink(sink, f))\r\nexports.mapTo = target => exports.map(x => target)\r\nexports.pluck = s => exports.map(d => d[s])\r\n\r\nclass Pairwise extends Sink {\r\n    init() {\r\n        this.hasLast = false\r\n    }\r\n    next(data) {\r\n        if (this.hasLast) {\r\n            this.sink.next([this.last, data])\r\n        } else {\r\n            this.hasLast = true\r\n        }\r\n        this.last = data\r\n    }\r\n}\r\nexports.pairwise = deliver(Pairwise)\r\n\r\nclass Repeat extends Sink {\r\n    init(count) {\r\n        this.buffer = []\r\n        this.count = count\r\n    }\r\n    next(data) {\r\n        this.buffer.push(data)\r\n        this.sink.next(data)\r\n    }\r\n    complete(err) {\r\n        if (err) super.complete(err)\r\n        else {\r\n            while (this.count--) {\r\n                for (let i = 0, l = this.buffer.length; i < l; this.sink.next(this.buffer[i++])) {\r\n                    if (this.disposed) return\r\n                }\r\n            }\r\n            super.complete()\r\n        }\r\n    }\r\n}\r\n\r\nexports.repeat = deliver(Repeat)\r\nclass _SwitchMap extends Sink {\r\n    init(data, context) {\r\n        this.data = data\r\n        this.context = context\r\n    }\r\n    next(data) {\r\n        const combineResults = this.context.combineResults\r\n        if (combineResults) {\r\n            this.sink.next(combineResults(this.data, data))\r\n        } else {\r\n            this.sink.next(data)\r\n        }\r\n    }\r\n    complete(err) {\r\n        if (this.context.disposed) super.complete(err)\r\n        else this.dispose(false)\r\n    }\r\n}\r\nclass SwitchMap extends Sink {\r\n    init(makeSource, combineResults) {\r\n        this.makeSource = makeSource\r\n        this.combineResults = combineResults\r\n    }\r\n    next(data) {\r\n        const makeSource = this.makeSource\r\n        if (this.switch) {\r\n            this.switch.disposePass = false\r\n            this.switch.dispose()\r\n        }\r\n        this.switch = new _SwitchMap(this.sink, data, this)\r\n        makeSource(data)(this.switch)\r\n    }\r\n    complete(err) {\r\n        if (!this.switch || this.switch.disposed) super.complete(err)\r\n        else this.dispose(false)\r\n    }\r\n}\r\n\r\nexports.switchMap = deliver(SwitchMap)\r\n\r\nexports.switchMapTo = (innerSource, combineResults) => exports.switchMap(d => innerSource, combineResults)\r\n\r\nclass BufferTime extends Sink {\r\n    init(miniseconds) {\r\n        this.buffer = []\r\n        this.id = setInterval(() => {\r\n            this.sink.next(this.buffer.concat());\r\n            this.buffer.length = 0\r\n        }, miniseconds)\r\n        this.defer([clearInterval, , this.id])\r\n    }\r\n    next(data) {\r\n        this.buffer.push(data)\r\n    }\r\n    complete(err) {\r\n        clearInterval(this.id)\r\n        if (!err) this.sink.next(this.buffer)\r\n        super.complete(err)\r\n    }\r\n}\r\n\r\nexports.bufferTime = deliver(BufferTime)"],"names":["require","Sink","deliver","MapSink","Scan","hasSeed","f","seed","aac","next","d","sink","data","exports","scan","args","source","length","map","fusionMap","mapTo","target","x","pluck","s","Pairwise","hasLast","last","pairwise","Repeat","count","buffer","push","err","i","l","disposed","repeat","_SwitchMap","context","combineResults","dispose","SwitchMap","makeSource","switch","disposePass","switchMap","switchMapTo","innerSource","BufferTime","miniseconds","id","setInterval","concat","defer","clearInterval","bufferTime"],"mappings":"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"}