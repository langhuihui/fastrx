{"version":3,"file":"extention.js","sources":["../extention.js"],"sourcesContent":["const { Sink } = require('./common')\r\nconst { rx, fromEventSource } = require('./index.js')\r\nexports.koaEventStream = async function (ctx, next) {\r\n    const sink = new Sink\r\n    const { res, req } = ctx;\r\n    res.writeHead(200, {\r\n        'Content-Type': 'text/event-stream', // <- Important headers\r\n        'Cache-Control': 'no-cache',\r\n        'Connection': 'keep-alive',\r\n        'X-Accel-Buffering': 'no'\r\n    });\r\n    sink.next = data => res.write((typeof data == 'string' ? data : \"data: \" + JSON.stringify(data)) + \"\\n\\n\");\r\n    sink.complete = err => res.end();\r\n    sink.defer([clearInterval, null, setInterval(() => res.write(':keep-alive\\n\\n'), 1000 * 30)]);\r\n    (await next())(sink)\r\n    ctx.respond = false\r\n    req.on(\"close\", () => sink.dispose())\r\n}\r\n\r\nexports.vueHookEvent = {\r\n    install(Vue, opt) {\r\n        Vue.prototype.$fromEvent = function (name) {\r\n            switch (name) {\r\n                case \"updated\":\r\n                case \"beforeUpdate\":\r\n                    return rx.fromVueEvent(this, \"hook:\" + name)\r\n                case \"beforeCreate\":\r\n                case \"created\":\r\n                case \"beforeMount\":\r\n                case \"mounted\":\r\n                case \"beforeDestroy\":\r\n                case \"destroyed\":\r\n                    return rx.fromVueEventOnce(this, \"hook:\" + name)\r\n                default:\r\n                    return rx.fromVueEvent(this, name)\r\n            }\r\n        }\r\n    }\r\n}\r\nexports.vueDirective = {\r\n    install(Vue, opt) {\r\n        Vue.directive('rx', {\r\n            bind: function (el, binding, vnode) {\r\n                const name = binding.arg\r\n                for (let eventName in binding.modifiers) {\r\n                    binding.value[name + eventName] = rx.fromEvent(el, eventName)\r\n                }\r\n            }\r\n        })\r\n    }\r\n}\r\n\r\n/**\r\n * VUE EventSource Component\r\n * @description auto connect and close EventSource\r\n */\r\nexports.vueEventSource = {\r\n    install(Vue, opt = {}) {\r\n        Vue.component(opt.id || 'EventSource', {\r\n            name: opt.name || \"EventSource\",\r\n            props: {\r\n                src: {\r\n                    type: String,\r\n                    default: null,\r\n                    required: true\r\n                },\r\n                value: {\r\n                    type: Object\r\n                },\r\n                list: {\r\n                    type: Array,\r\n                    default: () => []\r\n                },//use JSON.parse by default\r\n                json: {\r\n                    type: Boolean,\r\n                    default: true\r\n                },\r\n                desc: {\r\n                    type: Boolean,\r\n                    default: true\r\n                },//init fill the list use first incomeing array data\r\n                init: {\r\n                    type: Boolean,\r\n                    default: true\r\n                }\r\n            },\r\n            watch: {\r\n                desc(v, o) {\r\n                    if (v != o) {\r\n                        this.list.reverse()\r\n                    }\r\n                }\r\n            },\r\n            data() {\r\n                let srcChanged = null\r\n                let destroyed = null\r\n                rx(sink => srcChanged = sink).switchMap(fromEventSource)\r\n                    .takeUntil(sink => destroyed = sink)\r\n                    .subscribe(x => {\r\n                        if (this.json) {\r\n                            const data = JSON.parse(x);\r\n                            if (this.init && data instanceof Array) {\r\n                                if (this.desc) {\r\n                                    this.list.unshift.apply(this.list, data)\r\n                                } else {\r\n                                    this.list.push.apply(this.list, data)\r\n                                }\r\n                                this.$emit('update:list', this.list)\r\n                            }\r\n                            else {\r\n                                this.addData(data);\r\n                            }\r\n                        }\r\n                        else {\r\n                            this.addData(x);\r\n                        }\r\n                    }, e => this.$emit('error', e));\r\n                this.$watch('src', v => srcChanged.next(v), {\r\n                    immediate: true\r\n                })\r\n                return {\r\n                    destroyed\r\n                }\r\n            },\r\n            destroyed() {\r\n                this.destroyed.next(this)\r\n            },\r\n            methods: {\r\n                addData(data) {\r\n                    this.value = data\r\n                    this.$emit('input', data)\r\n                    this.desc ? this.list.unshift(data) : this.list.push(data);\r\n                    this.$emit('update:list', this.list)\r\n                }\r\n            },\r\n            render(h) {\r\n                if (typeof this.$scopedSlots.default == 'function')\r\n                    return this.$scopedSlots.default(this.list)\r\n                else return h()\r\n            }\r\n        })\r\n    }\r\n}"],"names":["require","Sink","rx","fromEventSource","exports","koaEventStream","ctx","next","sink","res","req","writeHead","data","write","JSON","stringify","complete","err","end","defer","clearInterval","setInterval","respond","on","dispose","vueHookEvent","install","Vue","opt","prototype","$fromEvent","name","fromVueEvent","fromVueEventOnce","vueDirective","directive","bind","el","binding","vnode","arg","eventName","modifiers","value","fromEvent","vueEventSource","component","id","props","src","type","String","default","required","Object","list","Array","json","Boolean","desc","init","watch","v","o","reverse","srcChanged","destroyed","switchMap","takeUntil","subscribe","x","parse","unshift","apply","push","$emit","addData","e","$watch","immediate","methods","render","h","$scopedSlots"],"mappings":"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"}